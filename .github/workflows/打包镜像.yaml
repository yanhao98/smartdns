# GitHub Actions å·¥ä½œæµé…ç½®
# ç”¨äºæ„å»º SmartDNS é¡¹ç›®å¹¶å‘å¸ƒ Docker é•œåƒ

name: CI æ„å»ºä¸å‘å¸ƒ

# è§¦å‘å·¥ä½œæµçš„äº‹ä»¶
on:
  push:
  workflow_dispatch:

# å…¨å±€ç¯å¢ƒå˜é‡
env:
  TZ: Asia/Shanghai

# é»˜è®¤ shell é…ç½®
defaults:
  run:
    shell: bash

jobs:
  # å¤šå¹³å°æ„å»ºä½œä¸š
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # AMD64 æ¶æ„é…ç½®
          - ARCH: amd64
            OPENSSL_TARGET: linux-x86_64
            CROSS_PREFIX: x86_64-linux-gnu-
            CARGO_TARGET: x86_64-unknown-linux-gnu
          # ARM64 æ¶æ„é…ç½®
          - ARCH: arm64
            OPENSSL_TARGET: linux-aarch64
            CROSS_PREFIX: aarch64-linux-gnu-
            APT_PKGS: gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu
            CARGO_TARGET: aarch64-unknown-linux-gnu

    env:
      CACHE_PREFIX: H_0330_1535
      OPENSSL_VER: 3.4.1
      OPENSSL_DIR: /tmp/openssl/${{ matrix.OPENSSL_TARGET }}

    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@main

      - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–åŒ…
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: ${{ matrix.APT_PKGS }} build-essential perl libfindbin-libs-perl
          version: ${{ env.CACHE_PREFIX }}-${{ matrix.ARCH }}-apt
          execute_install_scripts: false

      - name: ğŸ’¾ æ£€æŸ¥ OpenSSL ç¼“å­˜
        id: cache-openssl
        uses: actions/cache@v4
        with:
          path: ${{ env.OPENSSL_DIR }}
          key: ${{ env.CACHE_PREFIX }}-openssl-${{ matrix.ARCH }}-${{ env.OPENSSL_VER }}

      - name: ğŸ” éªŒè¯ OpenSSL äºŒè¿›åˆ¶æ–‡ä»¶
        if: steps.cache-openssl.outputs.cache-hit == 'true'
        id: check-openssl
        run: |
          if [ -f "${{ env.OPENSSL_DIR }}/bin/openssl" ]; then
            echo "openssl_exists=true" >> $GITHUB_OUTPUT
            file ${{ env.OPENSSL_DIR }}/bin/openssl
            ${{ env.OPENSSL_DIR }}/bin/openssl version -a || true
          else
            echo "openssl_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ”§ æ„å»º OpenSSL
        if: steps.cache-openssl.outputs.cache-hit != 'true' || steps.check-openssl.outputs.openssl_exists != 'true'
        run: |
          # è®¾ç½®å˜é‡
          OPENSSL_VER=${{ env.OPENSSL_VER }}
          OPENSSL_TARGET=${{ matrix.OPENSSL_TARGET }}
          OPENSSL_DIR=${{ env.OPENSSL_DIR }}
          OPENSSL_BUILD_DIR=/tmp/build-openssl
          CROSS_PREFIX=${{ matrix.CROSS_PREFIX }}
          PKG_ARCH=${{ matrix.ARCH }}

          # åˆ›å»ºæ„å»ºç›®å½•å¹¶ä¸‹è½½æºç 
          mkdir -p $OPENSSL_BUILD_DIR
          OPENSSL_URL="https://github.com/openssl/openssl/releases/download/openssl-${OPENSSL_VER}/openssl-${OPENSSL_VER}.tar.gz"
          curl -sSL $OPENSSL_URL | tar --strip-components=1 -zx -C $OPENSSL_BUILD_DIR

          cd $OPENSSL_BUILD_DIR

          # é…ç½® OpenSSL
          CONFIGURE_ARGS=(
            "--prefix=$OPENSSL_DIR"
            "--cross-compile-prefix=$CROSS_PREFIX"
            "no-shared"
            "no-tests"
            "${OPENSSL_TARGET}"
          )
          set -x
          ./Configure "${CONFIGURE_ARGS[@]}"

          # æ„å»ºå¹¶å®‰è£…
          MAKE_ARGS=("--silent")
          make "${MAKE_ARGS[@]}" all -j$(nproc)
          make "${MAKE_ARGS[@]}" install_sw

      - name: ğŸš€ æ„å»º SmartDNS
        run: |
          export CFLAGS="-I /tmp/openssl/${{ matrix.OPENSSL_TARGET }}/include"
          export LDFLAGS="-L /tmp/openssl/${{ matrix.OPENSSL_TARGET }}/lib -L /tmp/openssl/${{ matrix.OPENSSL_TARGET }}/lib64"
          BUILD_PKG_ARGS=(
            "--platform linux"
            "--arch ${{ matrix.ARCH }}"
            "--cross-tool ${{ matrix.CROSS_PREFIX }}"
          )
          set -x
          ldd --version
          sh ./package/build-pkg.sh ${BUILD_PKG_ARGS[@]}
          file src/smartdns || true
      # https://github.com/actions/cache/blob/main/examples.md#rust---cargo
      - name: âš¡ï¸ é…ç½® Cargo ç¼“å­˜
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            plugin/smartdns-ui/target
          key: ${{ env.CACHE_PREFIX }}-${{ runner.os }}-cargo-${{ matrix.ARCH }}-${{ hashFiles('**/Cargo.toml') }}
          restore-keys: |
            ${{ env.CACHE_PREFIX }}-${{ runner.os }}-cargo-${{ matrix.ARCH }}-
            ${{ env.CACHE_PREFIX }}-${{ runner.os }}-cargo-
            ${{ env.CACHE_PREFIX }}-${{ runner.os }}-

      - name: ğŸ¦€ å®‰è£… Rust å·¥å…·é“¾
        run: |
          if ! command -v rustup &>/dev/null; then
            echo "Rust not found, installing..."
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          else
            echo "Rust is already installed"
          fi
          # # Ensure cargo environment is sourced
          # . "$HOME/.cargo/env"

      - name: ğŸ¨ æ„å»º SmartDNS-UI æ’ä»¶
        working-directory: plugin/smartdns-ui
        run: |
          CARGO_LINKER=${{ matrix.CROSS_PREFIX }}gcc
          CARGO_TARGET=${{ matrix.CARGO_TARGET }}

          rustup target add $CARGO_TARGET

          CARGO_RUSTFLAGS=(
            "-C linker=$CARGO_LINKER"
            # "-C target-feature=-crt-static"
          )
          CARGO_BUILD_ARGS=(
            "--target $CARGO_TARGET"
            "--features build-release"
          )
          if [ "${OPTIMIZE_SIZE:-0}" = "1" ]; then
            CARGO_BUILD_ARGS+=("--profile release-optmize-size")
          else
            CARGO_BUILD_ARGS+=("--release")
          fi
          set -x
          export RUSTFLAGS="${CARGO_RUSTFLAGS[@]}"
          cargo build ${CARGO_BUILD_ARGS[@]}

          if [ "${OPTIMIZE_SIZE:-0}" = "1" ]; then
            du -sh target/$CARGO_TARGET/release-optmize-size/libsmartdns_ui.so
            file target/$CARGO_TARGET/release-optmize-size/libsmartdns_ui.so
          else
            du -sh target/$CARGO_TARGET/release/libsmartdns_ui.so
            file target/$CARGO_TARGET/release/libsmartdns_ui.so
          fi

      - name: ğŸ“¦ å‡†å¤‡æ„å»ºäº§ç‰©
        run: |
          mkdir -p /tmp/artifacts
          cp src/smartdns /tmp/artifacts
          cp plugin/smartdns-ui/target/${{ matrix.CARGO_TARGET }}/release/libsmartdns_ui.so /tmp/artifacts
          chmod +x /tmp/artifacts/*
          set -x
          file /tmp/artifacts/smartdns || true
          file /tmp/artifacts/libsmartdns_ui.so || true

          ldd /tmp/artifacts/smartdns || true
          ldd /tmp/artifacts/libsmartdns_ui.so || true
          # readelf -d /tmp/artifacts/smartdns || true
          # readelf -d /tmp/artifacts/libsmartdns_ui.so || true
          ls -l -R /tmp/artifacts

      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: smartdns-files-${{ matrix.ARCH }}
          path: /tmp/artifacts

  # Docker é•œåƒæ„å»ºå’Œå‘å¸ƒ
  docker:
    runs-on: ubuntu-latest
    needs: build
    env:
      # https://github.com/docker/metadata-action/tree/v5/?tab=readme-ov-file#semver
      # Event: push,     Ref: refs/head/main,       Tags: main
      # Event: push tag, Ref: refs/tags/v1.2.3,     Tags: 1.2.3, 1.2, 1, latest
      # Event: push tag, Ref: refs/tags/v2.0.8-rc1, Tags: 2.0.8-rc1
      metadata-action-tags: |
        type=ref,event=branch
        type=semver,pattern={{version}}
        type=semver,pattern={{major}}.{{minor}}
        type=semver,pattern={{major}}

    steps:
      - name: ğŸ“¥ æ£€å‡º Dockerfile
        uses: actions/checkout@main
        with:
          lfs: false
          sparse-checkout: |
            Dockerfile
          sparse-checkout-cone-mode: false

      - name: ğŸ“¥ ä¸‹è½½ SmartDNS æ„å»ºäº§ç‰©
        uses: dawidd6/action-download-artifact@v9
        with:
          run_id: ${{ github.run_id }}
          path: .
      - run: ls -l -R .

      - name: ğŸ“¥ ä¸‹è½½ SmartDNS-WebUI æ„å»ºäº§ç‰©
        uses: dawidd6/action-download-artifact@v9
        with:
          repo: ${{ github.repository_owner }}/smartdns-webui
          name: artifact-main # https://github.com/yanhao98/smartdns-webui/actions/workflows/_æ‰“åŒ…ä¸Šä¼ åˆ¶å“.yaml
          workflow_search: true
          path: webui-dist

      - name: ğŸ”‘ ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ³ æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
        uses: yanhao98/composite-actions/docker-build-push@main
        with:
          file: .github/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          load: false
          meta_images: ghcr.io/${{ github.repository }}
          meta_tags: ${{ env.metadata-action-tags }}
          cache-from: type=gha,scope=${{ github.workflow }}
          cache-to: type=gha,scope=${{ github.workflow }}
